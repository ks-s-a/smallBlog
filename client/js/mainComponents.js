"use strict";var Container=React.createClass({displayName:"Container",getDefaultProps:function(){return{queryTimeout:1e3}},getInitialState:function(){return{tagNames:TAG_NAMES,tags:[],tagNum:this.props.initialState.storiesCount||{},storyLastQueryTime:null,stories:this.props.initialState.stories||[],isEndReached:!1,lastStoryId:this.props.initialState.stories&&this.props.initialState.stories[this.props.initialState.stories.length-1].id}},_getArticleCount:function(){var t=this,e=JSON.stringify(this.state.tags),s=new XMLHttpRequest;s.onreadystatechange=function(){if(4==this.readyState&&this.responseText){var e=JSON.parse(this.responseText);t.setState({tagNum:e})}},s.open("GET","/getStoriesNumber?tags="+e,!0),s.send()},_getStoriesFromServer:function(){var t=Date.now();if(!(this.state.isEndReached||this.state.storyLastQueryTime&&t-this.state.storyLastQueryTime<this.props.queryTimeout)){var e=this,s=this.state.lastStoryId?"&last="+this.state.lastStoryId:"",a=new XMLHttpRequest;a.onreadystatechange=function(){if(4==this.readyState&&this.responseText){var t=JSON.parse(this.responseText);if(!t.length)return console.log("No more stories!"),void e.setState({isEndReached:!0});var s=t.sort(function(t,e){return e.id-t.id}),a=s[s.length-1].id,i=e.state.stories;s.forEach(function(t){i.push(t)}),e.setState({lastStoryId:a,stories:i})}},a.open("GET","/getStories?tags="+JSON.stringify(this.state.tags)+s,!0),a.send(),this.setState({storyLastQueryTime:t})}},_isNeedExtraStories:function(t){this._isEndCommingSoon(t)&&this._getStoriesFromServer()},_isEndCommingSoon:function(){var t=(this.refs.heading.getDOMNode().getBoundingClientRect(),document.documentElement),e=document.body,s=t.scrollTop||e&&e.scrollTop||0;return s-=t.clientTop,t.scrollHeight-s<1.5*t.clientHeight},changeTags:function(t){var e=this.state.tags.slice(),s=e.indexOf(t);-1===s?e.push(t):e.splice(s,1),this.replaceState(this.getInitialState()),this.setState({tags:e,tagNum:{},storyLastQueryTime:null,stories:[],isEndReached:!1,lastStoryId:null},function(){this._getArticleCount(),this._getStoriesFromServer()})},componentWillMount:function(){document&&document.addEventListener("scroll",this._isNeedExtraStories)},shouldComponentUpdate:function(t,e){return e.tagNum===this.state.tagNum&&e.lastStoryId===this.state.lastStoryId?!1:!0},render:function(){return React.createElement("div",{id:"content"},React.createElement("div",{className:"col-lg-3 col-md-3 hidden-sm hidden-xs"},React.createElement("img",{className:"main-picture",src:document?"/i/heartPic.png":"/client/i/heartPic.png"}),React.createElement(TagList,{tagNames:this.state.tagNames,tags:this.state.tags,tagNum:this.state.tagNum,changeTagsFunction:this.changeTags})),React.createElement(MobileList,{tagNames:this.state.tagNames,tags:this.state.tags,tagNum:this.state.tagNum,changeTagsFunction:this.changeTags}),React.createElement("div",{id:"heading",ref:"heading",className:"col-lg-9 col-md-9 col-sm-12 col-xs-12"},React.createElement("h1",{id:"main-header"},"Истории с чувством!"),React.createElement(Stories,{stories:this.state.stories,tagNames:this.state.tagNames,tags:this.state.tags,changeTagsFunction:this.changeTags})))}}),MobileList=React.createClass({displayName:"MobileList",showList:function(){var t=React.findDOMNode(this.refs.mobilePanel);t.classList.toggle("hide")},render:function(){var t=[];for(var e in this.props.tagNames)t.push(React.createElement(MobileListButton,{name:this.props.tagNames[e],state:-1!==this.props.tags.indexOf(+e),index:e,changeTagsFunction:this.props.changeTagsFunction,count:this.props.tagNum[e]}));return React.createElement("div",{id:"mobile-panel",className:"panel panel-default hidden-lg hidden-md col-sm-12 col-xs-12"},React.createElement("div",{className:"panel-heading",onClick:document?this.showList.bind(this):""},"Выбрать тему"),React.createElement("div",{id:"mobile-panel-content",ref:"mobilePanel",className:"panel-body "+(this.props.tags.length?"":"hide")},React.createElement("div",{className:"list-group"},t)))}}),MobileListButton=React.createClass({displayName:"MobileListButton",render:function(){return React.createElement("a",{href:"#",className:"list-group-item "+(this.props.state?"active":""),onClick:this.props.changeTagsFunction.bind(null,+this.props.index)},this.props.name," ",React.createElement("span",{className:"badge"},this.props.count))}}),TagList=React.createClass({displayName:"TagList",render:function(){var t=[];for(var e in this.props.tagNames)t.push(React.createElement(TagButton,{name:this.props.tagNames[e],state:-1!==this.props.tags.indexOf(+e),index:e,changeTagsFunction:this.props.changeTagsFunction,count:this.props.tagNum[e]}));return React.createElement("div",{id:"side-buttons"},React.createElement("h5",null,"Темы:"),React.createElement("ul",{className:"nav nav-pills nav-stacked"},t))}}),TagButton=React.createClass({displayName:"TagButton",render:function(){return React.createElement("li",{className:this.props.state?"active":""},React.createElement("a",{href:"#",onClick:this.props.changeTagsFunction.bind(null,+this.props.index)},this.props.name," ",React.createElement("span",{className:"badge"},this.props.count)))}}),Stories=React.createClass({displayName:"Stories",render:function(){var t=this,e=this.props.stories.map(function(e){return React.createElement(Story,{id:e.id,header:e.header,tags:e.tags,tagNames:t.props.tagNames,text:e.text,changeTagsFunction:t.props.changeTagsFunction})});return React.createElement("div",{id:"stories-container",ref:"storiesContainer",className:"col-lg-12 col-md-12 col-sm-12 col-xs-12"},e)}}),Story=React.createClass({displayName:"Story",render:function(){var t=this,e=this.props.tags.map(function(e){return React.createElement("a",{href:"javascript:",className:"text-muted story-tag-link",onClick:t.props.changeTagsFunction.bind(null,+e)}," ","#"+t.props.tagNames[+e]," ")});return React.createElement("article",{name:"post"+this.props.id},React.createElement("h4",{className:"story-title"}," ",this.props.header," "),React.createElement("div",{className:"story-tags-area"},e),this.props.text.split("\n").map(function(t){return React.createElement("p",null," ",t," ")}))}});React.render(React.createElement(Container,{initialState:INITIAL_STATE}),document.getElementById("content-container"));