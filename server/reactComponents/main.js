var React=require("react"),Container=React.createClass({displayName:"Container",getDefaultProps:function(){return{queryTimeout:1e3}},getInitialState:function(){return{activeTag:null,storyLastQueryTime:null,stories:this.props.stories||[],isEndReached:!1,lastStoryId:this.props.stories?this.props.stories[this.props.stories.length-1].id:null}},_getStoriesFromServer:function(){var t=Date.now();if(!(this.state.isEndReached||this.state.storyLastQueryTime&&t-this.state.storyLastQueryTime<this.props.queryTimeout)){var e=this,a=this.state.lastStoryId?"&last="+this.state.lastStoryId:"",s=new XMLHttpRequest;s.onreadystatechange=function(){if(4==this.readyState&&this.responseText){var t=JSON.parse(this.responseText);if(!t.length)return console.info("No more stories!"),e.setState({isEndReached:!0});var a=t.sort(function(t,e){return e.id-t.id}),s=a[a.length-1].id,i=e.state.stories;a.forEach(function(t){i.push(t)}),e.setState({lastStoryId:s,stories:i})}},s.open("GET","/getStories?tags="+JSON.stringify(this.state.activeTag?[this.state.activeTag]:[])+a,!0),s.send(),this.setState({storyLastQueryTime:t})}},_isNeedExtraStories:function(t){this._isEndCommingSoon(t)&&this._getStoriesFromServer()},_isEndCommingSoon:function(){var t=(document.getElementById("heading").getBoundingClientRect(),document.documentElement),e=document.body,a=t.scrollTop||e&&e.scrollTop||0;return a-=t.clientTop,t.scrollHeight-a<1.5*t.clientHeight},changeTags:function(t){this.setState({activeTag:this.state.activeTag===+t?null:+t,isEndReached:!1,lastStoryId:null,stories:[],storyLastQueryTime:null},function(){this._getStoriesFromServer()})},componentDidMount:function(){document.addEventListener("scroll",this._isNeedExtraStories)},render:function(){return React.createElement("div",{id:"content"},React.createElement("div",{className:"col-lg-3 col-md-3 hidden-sm hidden-xs"},React.createElement("img",{className:"main-picture",src:"/i/heartPic.png",alt:"История любви"}),React.createElement(TagList,{tagNames:this.props.tagNames,activeTag:this.state.activeTag,tagNum:this.props.tagNum,changeTagsFunction:this.changeTags})),React.createElement(MobileList,{tagNames:this.props.tagNames,tag:this.state.activeTag,tagNum:this.props.tagNum,changeTagsFunction:this.changeTags}),React.createElement("div",{id:"heading",className:"col-lg-9 col-md-9 col-sm-12 col-xs-12"},React.createElement("h1",{id:"main-header"},"История любви. Мы чувствуем!"),React.createElement("h2",{id:"second-header"},"Реальные истории любви"),React.createElement(Stories,{stories:this.state.stories,tagNames:this.props.tagNames,changeTagsFunction:this.changeTags})))}}),MobileList=React.createClass({displayName:"MobileList",getInitialState:function(){return{isShow:!!this.props.tag}},showList:function(){this.setState({isShow:!this.state.isShow})},render:function(){var t=[];for(var e in this.props.tagNames)t.push(React.createElement(MobileListButton,{key:"mobile-tag-"+e,name:this.props.tagNames[e],state:this.props.tag===+e,index:e,changeTagsFunction:this.props.changeTagsFunction,count:this.props.tagNum[e]}));return React.createElement("div",{id:"mobile-panel",className:"panel panel-default hidden-lg hidden-md col-sm-12 col-xs-12"},React.createElement("div",{className:"panel-heading",onClick:this.showList},"Выбрать тему"),React.createElement("div",{id:"mobile-panel-content",className:"panel-body "+(this.state.isShow?"":"hide")},React.createElement("div",{className:"list-group"},t)))}}),MobileListButton=React.createClass({displayName:"MobileListButton",render:function(){return React.createElement("a",{href:"#",className:"list-group-item "+(this.props.state?"active":""),onClick:this.props.changeTagsFunction.bind(null,+this.props.index)},this.props.name," ",React.createElement("span",{className:"badge"},this.props.count))}}),TagList=React.createClass({displayName:"TagList",render:function(){var t=[];for(var e in this.props.tagNames)t.push(React.createElement(TagButton,{key:"tag-"+e,name:this.props.tagNames[e],state:this.props.activeTag===+e,index:e,changeTagsFunction:this.props.changeTagsFunction,count:this.props.tagNum[e]}));return React.createElement("div",{id:"side-buttons"},React.createElement("h5",null,"Темы:"),React.createElement("ul",{className:"nav nav-pills nav-stacked"},t))}}),TagButton=React.createClass({displayName:"TagButton",render:function(){return React.createElement("li",{className:this.props.state?"active":""},React.createElement("a",{href:"#",onClick:this.props.changeTagsFunction.bind(null,+this.props.index)},this.props.name," ",React.createElement("span",{className:"badge"},this.props.count)))}}),Stories=React.createClass({displayName:"Stories",render:function(){var t=this.props.stories.map(function(t,e){return React.createElement(Story,{key:"story-"+e,id:t.id,header:t.header,tags:t.tags,tagNames:this.props.tagNames,text:t.text,changeTagsFunction:this.props.changeTagsFunction})}.bind(this));return React.createElement("div",{id:"stories-container",className:"col-lg-12 col-md-12 col-sm-12 col-xs-12"},t)}}),Story=React.createClass({displayName:"Story",_createParagraphs:function(t){return t.split("\n").map(function(t,e){return React.createElement("p",{key:"p-num-"+e},t)})},render:function(){var t=this.props.tags.map(function(t,e){return React.createElement("a",{key:"story-tag-"+e,href:"javascript:",className:"text-muted story-tag-link",onClick:this.props.changeTagsFunction.bind(null,+t)},"#"+this.props.tagNames[+t])}.bind(this)),e=this._createParagraphs(this.props.text);return React.createElement("article",{name:"post"+this.props.id},React.createElement("h4",{className:"story-title"}," ",this.props.header," "),React.createElement("div",{className:"story-tags-area"},t),e)}});module.exports=Container;